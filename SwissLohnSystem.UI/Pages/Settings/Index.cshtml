@page
@model SwissLohnSystem.UI.Pages.Settings.IndexModel
@{
    ViewData["Title"] = "Einstellungen";
}

<section class="content">
    <div class="container-fluid">

        <!-- SETTINGS -->
        <div class="row">
            <div class="col-md-8">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Payroll Einstellungen</h3>
                    </div>

                    <div class="card-body">
                        <form method="post" asp-page-handler="Save">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered align-middle">
                                    <thead class="thead-light">
                                        <tr>
                                            <th style="width:50%">Schlüssel (Name)</th>
                                            <th style="width:20%">Wert</th>
                                            <th>Beschreibung</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < Model.Settings.Count; i++)
                                        {
                                            <tr>
                                                <td class="font-monospace">
                                                    @Model.Settings[i].Name
                                                    <input type="hidden" asp-for="Settings[@i].Id" />
                                                    <input type="hidden" asp-for="Settings[@i].Name" />
                                                </td>
                                                <td>
                                                    <input asp-for="Settings[@i].Value"
                                                           type="number" step="0.0001"
                                                           class="form-control form-control-sm" />
                                                </td>
                                                <td>
                                                    <input asp-for="Settings[@i].Description"
                                                           class="form-control form-control-sm" />
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- QST TARIFE -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card card-outline card-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title">QST Tarife</h3>
                    </div>

                    <div class="card-body p-2">

                        <p class="text-muted mb-2">
                            <small>QST Count: @Model.QstTariffs?.Count</small>
                        </p>

                        <!-- CSV IMPORT (NEW) -->
                        <form method="post" asp-page-handler="ImportQstCsv" enctype="multipart/form-data" class="mb-3">
                            <div class="form-group mb-2">
                                <label>CSV import</label>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input asp-for="QstCsvFile" type="file" class="custom-file-input" accept=".csv,text/csv" required />
                                        <label class="custom-file-label" for="QstCsvFile">CSV auswählen...</label>
                                    </div>
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload"></i> Importieren
                                        </button>
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    Spalten: Canton;Code;PermitType;ChurchMember;IncomeFrom;IncomeTo;Rate;Remark
                                </small>
                            </div>
                        </form>

                        <!-- MEVCUT TARIFELER: Listele + Güncelle + Sil -->
                        <form method="post">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered align-middle">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Id</th>
                                            <th>Kanton</th>
                                            <th>Code</th>
                                            <th>Bewilligung</th>
                                            <th>Kirche?</th>
                                            <th>Income From</th>
                                            <th>Income To</th>
                                            <th>Rate</th>
                                            <th>Bemerkung</th>
                                            <th style="width:70px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.QstTariffs != null && Model.QstTariffs.Count > 0)
                                        {
                                            for (int i = 0; i < Model.QstTariffs.Count; i++)
                                            {
                                                <tr>
                                                    <td>
                                                        @Model.QstTariffs[i].Id
                                                        <input type="hidden" asp-for="QstTariffs[@i].Id" />
                                                    </td>

                                                    <td>
                                                        <select asp-for="QstTariffs[@i].Canton"
                                                                class="form-control form-control-sm">
                                                            <option value="">--</option>
                                                            <option value="AG">Aargau (AG)</option>
                                                            <option value="AI">Appenzell Innerrhoden (AI)</option>
                                                            <option value="AR">Appenzell Ausserrhoden (AR)</option>
                                                            <option value="BE">Bern (BE)</option>
                                                            <option value="BL">Basel-Landschaft (BL)</option>
                                                            <option value="BS">Basel-Stadt (BS)</option>
                                                            <option value="FR">Freiburg / Fribourg (FR)</option>
                                                            <option value="GE">Genève / Genf (GE)</option>
                                                            <option value="GL">Glarus (GL)</option>
                                                            <option value="GR">Graubünden / Grisons (GR)</option>
                                                            <option value="JU">Jura (JU)</option>
                                                            <option value="LU">Luzern (LU)</option>
                                                            <option value="NE">Neuchâtel (NE)</option>
                                                            <option value="NW">Nidwalden (NW)</option>
                                                            <option value="OW">Obwalden (OW)</option>
                                                            <option value="SG">St. Gallen (SG)</option>
                                                            <option value="SH">Schaffhausen (SH)</option>
                                                            <option value="SZ">Schwyz (SZ)</option>
                                                            <option value="SO">Solothurn (SO)</option>
                                                            <option value="TG">Thurgau (TG)</option>
                                                            <option value="TI">Ticino / Tessin (TI)</option>
                                                            <option value="UR">Uri (UR)</option>
                                                            <option value="VD">Vaud / Waadt (VD)</option>
                                                            <option value="VS">Valais / Wallis (VS)</option>
                                                            <option value="ZG">Zug (ZG)</option>
                                                            <option value="ZH">Zürich (ZH)</option>
                                                        </select>
                                                    </td>

                                                    <td>
                                                        <select asp-for="QstTariffs[@i].Code"
                                                                class="form-control form-control-sm">
                                                            <option value="">--</option>
                                                            <option>A</option>
                                                            <option>B</option>
                                                            <option>C</option>
                                                            <option>D</option>
                                                            <option>H</option>
                                                        </select>
                                                    </td>

                                                    <td>
                                                        <select asp-for="QstTariffs[@i].PermitType"
                                                                class="form-control form-control-sm">
                                                            <option value="">--</option>
                                                            <option>B</option>
                                                            <option>L</option>
                                                            <option>F</option>
                                                            <option>N</option>
                                                        </select>
                                                    </td>

                                                    <td class="text-center">
                                                        <input asp-for="QstTariffs[@i].ChurchMember"
                                                               type="checkbox"
                                                               class="form-check-input mt-2" />
                                                    </td>

                                                    <td>
                                                        <input asp-for="QstTariffs[@i].IncomeFrom"
                                                               type="number" step="0.01"
                                                               class="form-control form-control-sm" />
                                                    </td>

                                                    <td>
                                                        <input asp-for="QstTariffs[@i].IncomeTo"
                                                               type="number" step="0.01"
                                                               class="form-control form-control-sm" />
                                                    </td>

                                                    <td>
                                                        <input asp-for="QstTariffs[@i].Rate"
                                                               type="number" step="0.0001"
                                                               class="form-control form-control-sm" />
                                                    </td>

                                                    <td>
                                                        <input asp-for="QstTariffs[@i].Remark"
                                                               class="form-control form-control-sm" />
                                                    </td>

                                                    <td class="text-center">
                                                        @if (Model.QstTariffs[i].Id > 0)
                                                        {
                                                            <button type="submit"
                                                                    class="btn btn-danger btn-sm"
                                                                    asp-page-handler="DeleteQst"
                                                                    asp-route-id="@Model.QstTariffs[i].Id"
                                                                    title="Löschen">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="10" class="text-center text-muted">
                                                    Keine QST-Tarife vorhanden.
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <button type="submit"
                                    asp-page-handler="SaveQst"
                                    class="btn btn-primary btn-sm mt-2">
                                <i class="fas fa-save"></i> Änderungen speichern
                            </button>
                        </form>

                        <hr />

                        <!-- YENİ QST-TARIF EKLEME -->
                        <h6 class="mt-3">Neuer QST-Tarif</h6>

                        <form method="post" asp-page-handler="CreateQst" class="mt-2">
                            <div class="form-row">
                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.Canton">Kanton</label>
                                    <select asp-for="NewQst.Canton"
                                            class="form-control form-control-sm">
                                        <option value="">--</option>
                                        <option value="AG">Aargau (AG)</option>
                                        <option value="AI">Appenzell Innerrhoden (AI)</option>
                                        <option value="AR">Appenzell Ausserrhoden (AR)</option>
                                        <option value="BE">Bern (BE)</option>
                                        <option value="BL">Basel-Landschaft (BL)</option>
                                        <option value="BS">Basel-Stadt (BS)</option>
                                        <option value="FR">Freiburg / Fribourg (FR)</option>
                                        <option value="GE">Genève / Genf (GE)</option>
                                        <option value="GL">Glarus (GL)</option>
                                        <option value="GR">Graubünden / Grisons (GR)</option>
                                        <option value="JU">Jura (JU)</option>
                                        <option value="LU">Luzern (LU)</option>
                                        <option value="NE">Neuchâtel (NE)</option>
                                        <option value="NW">Nidwalden (NW)</option>
                                        <option value="OW">Obwalden (OW)</option>
                                        <option value="SG">St. Gallen (SG)</option>
                                        <option value="SH">Schaffhausen (SH)</option>
                                        <option value="SZ">Schwyz (SZ)</option>
                                        <option value="SO">Solothurn (SO)</option>
                                        <option value="TG">Thurgau (TG)</option>
                                        <option value="TI">Ticino / Tessin (TI)</option>
                                        <option value="UR">Uri (UR)</option>
                                        <option value="VD">Vaud / Waadt (VD)</option>
                                        <option value="VS">Valais / Wallis (VS)</option>
                                        <option value="ZG">Zug (ZG)</option>
                                        <option value="ZH">Zürich (ZH)</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.Code">Code</label>
                                    <select asp-for="NewQst.Code"
                                            class="form-control form-control-sm">
                                        <option value="">--</option>
                                        <option>A</option>
                                        <option>B</option>
                                        <option>C</option>
                                        <option>D</option>
                                        <option>H</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.PermitType">Bewilligung</label>
                                    <select asp-for="NewQst.PermitType"
                                            class="form-control form-control-sm">
                                        <option value="">--</option>
                                        <option>B</option>
                                        <option>L</option>
                                        <option>F</option>
                                        <option>N</option>
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.ChurchMember">Kirche?</label>
                                    <div class="form-check mt-1">
                                        <input asp-for="NewQst.ChurchMember"
                                               class="form-check-input"
                                               type="checkbox" />
                                    </div>
                                </div>

                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.IncomeFrom">Income From</label>
                                    <input asp-for="NewQst.IncomeFrom"
                                           type="number" step="0.01"
                                           class="form-control form-control-sm" />
                                </div>

                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.IncomeTo">Income To</label>
                                    <input asp-for="NewQst.IncomeTo"
                                           type="number" step="0.01"
                                           class="form-control form-control-sm" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-2">
                                    <label asp-for="NewQst.Rate">Rate</label>
                                    <input asp-for="NewQst.Rate"
                                           type="number" step="0.0001"
                                           class="form-control form-control-sm" />
                                </div>
                                <div class="form-group col-md-6">
                                    <label asp-for="NewQst.Remark">Bemerkung</label>
                                    <input asp-for="NewQst.Remark"
                                           class="form-control form-control-sm" />
                                </div>
                                <div class="form-group col-md-4 d-flex align-items-end">
                                    <button type="submit"
                                            class="btn btn-success btn-sm">
                                        <i class="fas fa-plus"></i> Hinzufügen
                                    </button>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // toastr
            if (window.toastr) {
                @if (TempData["Toast"] is string ok)
                {
                        <text>toastr.success('@ok');</text>
                }
                @if (TempData["Error"] is string err)
                {
                        <text>toastr.error('@err');</text>
                }
            }

            // custom-file label update (AdminLTE)
            var input = document.getElementById("QstCsvFile");
            if (input) {
                input.addEventListener("change", function () {
                    if (input.files && input.files.length > 0) {
                        var label = input.nextElementSibling;
                        if (label) label.innerText = input.files[0].name;
                    }
                });
            }
        });
    </script>
}
