@page "{id:int}"
@model SwissLohnSystem.UI.Pages.Lohn.DetailsModel
@{
    ViewData["Title"] = "Lohnabrechnung";
    Layout = "_Layout";
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Lohnabrechnung</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="~/">Dashboard</a></li>
                    @if (Model.Lohn?.CompanyId != null)
                    {
                        <li class="breadcrumb-item">
                            <a href="~/Companies/Details/@Model.Lohn.CompanyId#loehne">
                                @Model.Lohn.CompanyName
                            </a>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item">Firma</li>
                    }
                    <li class="breadcrumb-item active">Lohn</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        @if (!string.IsNullOrWhiteSpace(Model.Error))
        {
            <div class="alert alert-danger">@Model.Error</div>
        }
        else if (Model.Lohn is null)
        {
            <div class="alert alert-warning">Keine Daten vorhanden.</div>
        }
        else
        {
            var l = Model.Lohn!;
            var periodText = $"{l.Month:00}.{l.Year}";

            <div class="row">
                <!-- SOL KART: Mitarbeiter -->
                <div class="col-md-4">
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Mitarbeiter</h3>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-5">Name</dt>
                                <dd class="col-7" id="employeeName">@l.EmployeeName</dd>

                                <dt class="col-5">Firma</dt>
                                <dd class="col-7" id="companyName">@l.CompanyName</dd>

                                <dt class="col-5">Periode</dt>
                                <dd class="col-7" id="period">@periodText</dd>

                                <dt class="col-5">Status</dt>
                                <dd class="col-7">
                                    <span id="badgeStatus"
                                          class="badge @(l.IsFinal ? "badge-success" : "badge-warning")">
                                        @(l.IsFinal ? "Final" : "Entwurf")
                                    </span>
                                </dd>

                                <dt class="col-5">Erstellt am</dt>
                                <dd class="col-7" id="createdAt">
                                    @l.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                                </dd>

                                <dt class="col-5">Monatsstunden</dt>
                                <dd class="col-7" id="labelMonthlyHours">
                                    @($"{l.MonthlyHours:N2} h")
                                </dd>

                                <dt class="col-5">Überstunden</dt>
                                <dd class="col-7" id="labelMonthlyOvertime">
                                    @($"{l.MonthlyOvertimeHours:N2} h")
                                </dd>

                                <dt class="col-5">Gearbeitete Tage</dt>
                                <dd class="col-7" id="labelWorkedDays">
                                    wird geladen…
                                </dd>

                                <dt class="col-5">Quellensteuer</dt>
                                <dd class="col-7">
                                    @if (l.ApplyQST)
                                    {
                                        <span>
                                            Aktiv (@l.WithholdingTaxCode / @l.Canton)
                                        </span>
                                    }
                                    else
                                    {
                                        <span>Keine</span>
                                    }
                                </dd>

                                <dt class="col-5">Kirchensteuer</dt>
                                <dd class="col-7">
                                    @(l.ChurchMember ? "Kirchensteuerpflichtig" : "Keine Kirchensteuer")
                                </dd>
                            </dl>

                            <div class="mt-3">
                                <a class="btn btn-outline-secondary btn-sm"
                                   href="~/Employees/Details/@l.EmployeeId">
                                    <i class="fas fa-user"></i> Mitarbeiter öffnen
                                </a>
                                @if (l.CompanyId != null)
                                {
                                    <a class="btn btn-outline-secondary btn-sm ml-1"
                                       href="~/Companies/Details/@l.CompanyId#loehne">
                                        <i class="fas fa-building"></i> Firma / Löhne
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAĞ KART: Zusammenfassung + Slip -->
                <div class="col-md-8">
                    <div class="card card-outline card-success">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0">Zusammenfassung</h3>
                            <div class="btn-group">
                                @if (!l.IsFinal)
                                {
                                    <button id="btnFinalize"
                                            type="button"
                                            class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-check"></i> Finalisieren
                                    </button>
                                }
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary ml-1"
                                        id="btnLdmPrint">
                                    <i class="fas fa-print"></i> Drucken / PDF
                                </button>
                            </div>
                        </div>
                        <div class="card-body">

                            <!-- Özet kutular -->
                            <div class="row text-center mb-3">
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <div class="text-muted small">Bruttolohn</div>
                                        <div class="h5 mb-0" id="cardGross">
                                            @l.BruttoSalary.ToString("N2") CHF
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <div class="text-muted small">Abzüge (AN)</div>
                                        <div class="h5 mb-0" id="cardEmpTotal">
                                            @l.TotalDeductions.ToString("N2") CHF
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <div class="text-muted small">AG-Kosten</div>
                                        <div class="h5 mb-0" id="cardErTotal">
                                            wird geladen…
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <div class="text-muted small">Netto</div>
                                        <div class="h5 mb-0" id="cardNet">
                                            @l.NetSalary.ToString("N2") CHF
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Printable SLIP -->
                            <div id="lohnDetailPrintable" class="p-2 border rounded">
                                <div class="row mb-3 small">
                                    <div class="col-sm-6">
                                        <strong>@l.CompanyName</strong><br />
                                        <!-- İstersen ileride CompanyAddress vs. buraya ekleriz -->
                                    </div>
                                    <div class="col-sm-6 text-right">
                                        @DateTime.Today.ToString("dd.MM.yyyy")<br />
                                        <br />
                                        <strong>Mitarbeiter</strong><br />
                                        @l.EmployeeName
                                    </div>
                                </div>

                                <h5 class="mb-2">
                                    Lohnabrechnung
                                    <span id="ldmPeriodHeader" class="text-muted">
                                        @($"{l.Month:00}.{l.Year}")
                                    </span>
                                </h5>

                                <div class="row mb-2 small">
                                    <div class="col-sm-6">
                                        <strong>Gesamtstunden im Monat:</strong>
                                        <span id="ldmMonthlyHours">@($"{l.MonthlyHours:N2} h")</span>
                                    </div>
                                    <div class="col-sm-6 text-right">
                                        <strong>Überstunden im Monat:</strong>
                                        <span id="ldmMonthlyOvertime">@($"{l.MonthlyOvertimeHours:N2} h")</span>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="ldmSlipTable">
                                        <thead class="thead-light">
                                            <tr>
                                                <th style="width:40%;">Legende</th>
                                                <th style="width:10%;" class="text-right">%</th>
                                                <th style="width:15%;" class="text-right">Menge</th>
                                                <th style="width:15%;" class="text-right">Ansatz</th>
                                                <th style="width:20%;" class="text-right">Betrag</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ldmSlipBody">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    Wird geladen…
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <p class="text-muted small mt-3 mb-0">
                                Hinweis: Die Detailpositionen (AN/AG) stammen aus der aktuellen Berechnung
                                des Payroll-Motors für diesen Monat. Die zusammengefassten Beträge sind
                                zusätzlich als Snapshot in der Lohnabrechnung gespeichert.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        window.API_BASE_URL      = '@(ViewData["ApiBaseUrl"] ?? "")';
        window.LOHN_EMPLOYEE_ID  = @((Model.Lohn?.EmployeeId ?? 0));
        window.LOHN_MONTH        = @((Model.Lohn?.Month ?? 0));
        window.LOHN_YEAR         = @((Model.Lohn?.Year ?? 0));

        window.LOHN_BRUTTO       = @((Model.Lohn?.BruttoSalary ?? 0m));
        window.LOHN_NETTO        = @((Model.Lohn?.NetSalary ?? 0m));
        window.LOHN_TOTAL_DEDU   = @((Model.Lohn?.TotalDeductions ?? 0m));
    </script>
    <script src="~/js/lohne-details.js"></script>
}
