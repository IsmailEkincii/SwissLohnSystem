@page "{id:int}"
@using SwissLohnSystem.UI.DTOs.Lohn
@model SwissLohnSystem.UI.Pages.Lohn.DetailsModel
@{
    ViewData["Title"] = "Lohnabrechnung";
    Layout = "_Layout";
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Lohnabrechnung</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="~/">Dashboard</a></li>
                    @if (Model.Lohn?.CompanyId != null)
                    {
                        <li class="breadcrumb-item">
                            <a href="~/Companies/Details/@Model.Lohn.CompanyId#loehne">
                                @Model.Lohn.CompanyName
                            </a>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item">Firma</li>
                    }
                    <li class="breadcrumb-item active">Lohn</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        @if (!string.IsNullOrWhiteSpace(Model.Error))
        {
            <div class="alert alert-danger">@Model.Error</div>
        }
        else if (Model.Lohn is null)
        {
            <div class="alert alert-warning">Keine Daten vorhanden.</div>
        }
        else
        {
            var l = Model.Lohn!;
            var periodText = $"{l.Month:00}.{l.Year}";

            var employerTotal =
            l.EmployerAhvIvEo +
            l.EmployerAlv +
            l.EmployerBu +
            l.EmployerBvg +
            l.EmployerFak;

            var items = l.Items ?? new List<LohnSlipItemDto>();

            var earnings = items.Where(x => x.Group == LohnSlipGroup.Earnings).OrderBy(x => x.SortOrder).ToList();
            var deductionsEmployee = items.Where(x => x.Group == LohnSlipGroup.DeductionsEmployee).OrderBy(x => x.SortOrder).ToList();
            var contributionsEmployer = items.Where(x => x.Group == LohnSlipGroup.ContributionsEmployer).OrderBy(x => x.SortOrder).ToList();

            string FormatBase(decimal? v) => v.HasValue ? v.Value.ToString("N2") : "—";

            string FormatRate(LohnSlipItemDto it)
            {
                if (!string.IsNullOrWhiteSpace(it.RateText))
                    return it.RateText!;

                return it.Rate.HasValue
                ? (it.Rate.Value.ToString("N2") + " %")
                : "—";
            }

            <div class="row">
                <!-- Sol kart print'te görünmesin -->
                <div class="col-md-4 d-print-none">
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Mitarbeiter</h3>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-5">Name</dt>
                                <dd class="col-7">@l.EmployeeName</dd>

                                <dt class="col-5">Firma</dt>
                                <dd class="col-7">@l.CompanyName</dd>

                                <dt class="col-5">Periode</dt>
                                <dd class="col-7">@periodText</dd>

                                <dt class="col-5">Status</dt>
                                <dd class="col-7">
                                    <span class="badge @(l.IsFinal ? "badge-success" : "badge-warning")">
                                        @(l.IsFinal ? "Final" : "Entwurf")
                                    </span>
                                </dd>

                                <dt class="col-5">Erstellt am</dt>
                                <dd class="col-7">
                                    @@(item.Rate.HasValue ? item.Rate.Value.ToString("0.00") : "")
                                </dd>

                                <dt class="col-5">Monatsstunden</dt>
                                <dd class="col-7">@($"{l.MonthlyHours:N2} h")</dd>

                                <dt class="col-5">Überstunden</dt>
                                <dd class="col-7">@($"{l.MonthlyOvertimeHours:N2} h")</dd>

                                <dt class="col-5">Quellensteuer</dt>
                                <dd class="col-7">
                                    @if (l.ApplyQST)
                                    {
                                        <span>Aktiv (@l.WithholdingTaxCode / @l.Canton)</span>
                                    }
                                    else
                                    {
                                        <span>Keine</span>
                                    }
                                </dd>

                                <dt class="col-5">Kirchensteuer</dt>
                                <dd class="col-7">@(l.ChurchMember ? "Kirchensteuerpflichtig" : "Keine Kirchensteuer")</dd>
                            </dl>

                            <div class="mt-3">
                                <a class="btn btn-outline-secondary btn-sm"
                                   href="~/Employees/Details/@l.EmployeeId">
                                    <i class="fas fa-user"></i> Mitarbeiter öffnen
                                </a>

                                @if (l.CompanyId != null)
                                {
                                    <a class="btn btn-outline-secondary btn-sm ml-1"
                                       href="~/Companies/Details/@l.CompanyId#loehne">
                                        <i class="fas fa-building"></i> Firma / Löhne
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card card-outline card-success">
                        <!-- Üst başlık print'te görünmesin -->
                        <div class="card-header d-flex justify-content-between align-items-center d-print-none">
                            <h3 class="card-title mb-0">
                                Zusammenfassung
                                <small class="text-muted">(@periodText)</small>
                            </h3>
                            <div class="btn-group">
                                @if (!l.IsFinal)
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-success d-print-none"
                                            id="btnFinalize">
                                        <i class="fas fa-check"></i> Finalisieren
                                    </button>
                                }
                                @if (l.IsFinal)
                                {
                                    <a class="btn btn-sm btn-primary d-print-none"
                                       href="@( (ViewData["ApiBaseUrl"] ?? "").ToString()?.TrimEnd('/') + $"/api/Lohn/{l.Id}/pdf")"
                                       target="_blank">
                                        <i class="fas fa-file-pdf"></i> PDF herunterladen
                                    </a>
                                }
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary d-print-none"
                                        id="btnLdmPrint"
                                        onclick="window.print();">
                                    <i class="fas fa-print"></i> Drucken / PDF
                                </button>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Özet kutular print'te görünmesin -->
                            <div class="row text-center mb-3 d-print-none">
                                <div class="col-md-3 mb-2">
                                    <div class="small-box bg-light">
                                        <div class="inner">
                                            <small class="text-muted">Bruttolohn</small>
                                            <h5 class="mb-0">@l.BruttoSalary.ToString("N2") CHF</h5>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-2">
                                    <div class="small-box bg-light">
                                        <div class="inner">
                                            <small class="text-muted">Abzüge (AN)</small>
                                            <h5 class="mb-0">@l.TotalDeductions.ToString("N2") CHF</h5>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-2">
                                    <div class="small-box bg-light">
                                        <div class="inner">
                                            <small class="text-muted">AG-Kosten</small>
                                            <h5 class="mb-0">@employerTotal.ToString("N2") CHF</h5>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-2">
                                    <div class="small-box bg-success">
                                        <div class="inner text-white">
                                            <small>Netto</small>
                                            <h5 class="mb-0">@l.NetSalary.ToString("N2") CHF</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ================= PRINT AREA / SLIP ================= -->
                            <div id="lohnDetailPrintable" class="p-2 border rounded print-area">

                                <!-- PRINT LETTERHEAD (sadece print) -->
                                <div class="d-none d-print-block mb-3">
                                    <div class="row mb-2">
                                        <div class="col-6 small">
                                            <strong>@l.CompanyName</strong><br />

                                            @if (!string.IsNullOrWhiteSpace(l.CompanyAddress))
                                            {
                                                @l.CompanyAddress
                                        
                                                <br />
                                            }
                                            @if (!string.IsNullOrWhiteSpace(l.CompanyPhone))
                                            {
                                                @l.CompanyPhone
                                        
                                                <br />
                                            }
                                            @if (!string.IsNullOrWhiteSpace(l.CompanyEmail))
                                            {
                                                @l.CompanyEmail
                                        
                                                <br />
                                            }
                                        </div>

                                        <div class="col-6 small text-right">
                                            @DateTime.Today.ToString("dd.MM.yyyy")<br /><br />

                                            <strong>Mitarbeiter</strong><br />
                                            @l.EmployeeName<br />
                                            @l.EmployeeAhvNumber<br />

                                            @if (!string.IsNullOrWhiteSpace(l.EmployeeAddress))
                                            {
                                                @l.EmployeeAddress
                                        
                                                <br />

                                                @if (!string.IsNullOrWhiteSpace(l.EmployeeZip) || !string.IsNullOrWhiteSpace(l.EmployeeCity))
                                                {
                                                    @($"{l.EmployeeZip} {l.EmployeeCity}".Trim())
                                        
                                                    <br />
                                                }
                                            }

                                            @if (!string.IsNullOrWhiteSpace(l.EmployeePhone))
                                            {
                                                @l.EmployeePhone
                                        
                                                <br />
                                            }
                                        </div>
                                    </div>

                                    <h5 class="mb-2 lohn-title">
                                        Lohnabrechnung <span class="text-muted">@periodText</span>
                                    </h5>

                                    <div class="row mb-2">
                                        <div class="col-6 small">
                                            <strong>Gesamtstunden im Monat:</strong> @($"{l.MonthlyHours:N2} h")
                                        </div>
                                        <div class="col-6 small text-right">
                                            <strong>Überstunden im Monat:</strong> @($"{l.MonthlyOvertimeHours:N2} h")
                                        </div>
                                    </div>
                                </div>

                                <!-- TABLE -->
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="ldmSlipTable">
                                        <thead class="thead-light">
                                            <tr>
                                                <th style="width:52%;">Legende</th>
                                                <th style="width:16%;" class="text-right">Basis</th>
                                                <th style="width:14%;" class="text-right">Satz</th>
                                                <th style="width:18%;" class="text-right">Betrag (CHF)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var it in earnings)
                                            {
                                                <tr class="font-weight-bold">
                                                    <td>@it.Title</td>
                                                    <td class="text-right">@FormatBase(it.Base)</td>
                                                    <td class="text-right">@FormatRate(it)</td>
                                                    <td class="text-right">@it.Amount.ToString("N2")</td>
                                                </tr>
                                            }

                                            @if (deductionsEmployee.Any())
                                            {
                                                <tr class="table-secondary">
                                                    <td colspan="4"><strong>Abzüge Arbeitnehmer (AN)</strong></td>
                                                </tr>

                                                @foreach (var it in deductionsEmployee)
                                                {
                                                    <tr>
                                                        <td>@it.Title</td>
                                                        <td class="text-right">@FormatBase(it.Base)</td>
                                                        <td class="text-right">@FormatRate(it)</td>
                                                        <td class="text-right">@it.Amount.ToString("N2")</td>
                                                    </tr>
                                                }
                                            }

                                            @if (contributionsEmployer.Any())
                                            {
                                                <tr class="table-secondary">
                                                    <td colspan="4"><strong>Beiträge Arbeitgeber (AG)</strong></td>
                                                </tr>

                                                @foreach (var it in contributionsEmployer)
                                                {
                                                    <tr>
                                                        <td>@it.Title</td>
                                                        <td class="text-right">@FormatBase(it.Base)</td>
                                                        <td class="text-right">@FormatRate(it)</td>
                                                        <td class="text-right">@it.Amount.ToString("N2")</td>
                                                    </tr>
                                                }
                                            }

                                            <tr class="font-weight-bold table-success">
                                                <td>Nettoauszahlung</td>
                                                <td class="text-right">—</td>
                                                <td class="text-right">—</td>
                                                <td class="text-right">@l.NetSalary.ToString("N2")</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                @* Print Totals + Signature (istersen)
                                <div class="print-totals d-none d-print-block">...</div>
                                <div class="print-footer d-none d-print-block">...</div>
                                *@

                            </div>
                            <!-- ================= END PRINT AREA ================= -->

                            <p class="text-muted small mt-3 mb-0 d-print-none">
                                Hinweis: Diese Ansicht zeigt die gespeicherten Snapshot-Beträge der Lohnabrechnung.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        window.API_BASE_URL = '@(ViewData["ApiBaseUrl"] ?? "")';
        window.LOHN_ID = @Model.Id;
    </script>
    <script src="~/js/lohne-details.js"></script>
}
